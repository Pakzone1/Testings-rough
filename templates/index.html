<!DOCTYPE html>
<html>
<head>
    <title>WhatsApp Bot Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            min-height: 100vh;
            background: #f5f6fa;
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #2d3436;
            font-size: 1.8rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .nav-link.orders {
            background: #00b894;
            color: white;
        }

        .nav-link.logout {
            background: #ff7675;
            color: white;
        }

        .nav-link:hover {
            opacity: 0.9;
        }

        .logout {
            background: #ff7675;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .logout:hover {
            background: #d63031;
        }

        .status {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            font-size: 1.1rem;
        }

        .status.connected {
            border-left: 5px solid #00b894;
            color: #00b894;
        }

        .status.disconnected {
            border-left: 5px solid #ff7675;
            color: #ff7675;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .button {
            padding: 1rem;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .button.start {
            background: #00b894;
        }

        .button.stop {
            background: #ff7675;
        }

        .button.reset {
            background: #0984e3;
        }

        .button.download {
            background: #6c5ce7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button.download:hover {
            background: #5b4cdb;
        }

        .button.download::before {
            content: "üì•";
        }

        .qr-code {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .qr-code img {
            max-width: 300px;
            height: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .status-message {
            background: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 5px solid #ffeeba;
            font-size: 1rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease-out;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #f5c6cb;
        }

        /* Control Panel Guide Styles */
        .controls-description {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }

        .description-title {
            font-size: 1.2rem;
            color: #2d3436;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .button-descriptions {
            display: grid;
            gap: 1rem;
        }

        .button-description {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .button-description:hover {
            background: #f5f6fa;
        }

        .button-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: white;
            flex-shrink: 0;
        }

        .button-icon.start { background: #00b894; }
        .button-icon.stop { background: #ff7675; }
        .button-icon.reset { background: #0984e3; }

        .button-info {
            flex: 1;
        }

        .button-name {
            font-weight: 500;
            color: #2d3436;
            margin-bottom: 0.25rem;
        }

        .button-detail {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Command Reference Styles */
        .commands-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }

        .commands-title {
            font-size: 1.2rem;
            color: #2d3436;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .commands-grid {
            display: grid;
            gap: 1.5rem;
        }

        .command-group {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
        }

        .command-group.admin {
            border-left: 4px solid #0984e3;
        }

        .command-group.moderator {
            border-left: 4px solid #00b894;
        }

        .command-group.user {
            border-left: 4px solid #fdcb6e;
        }

        .command-group-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2d3436;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .command-list {
            display: grid;
            gap: 1rem;
        }

        .command-item {
            display: grid;
            gap: 0.25rem;
        }

        .command-name {
            font-family: monospace;
            font-size: 0.95rem;
            color: #0984e3;
            background: #0984e315;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .command-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>WhatsApp Bot Dashboard</h1>
            <div class="nav-links">
                <a href="/orders" class="nav-link orders">Orders</a>
                <a href="/logout" class="nav-link logout">Logout</a>
            </div>
        </div>

        <div id="status" class="status disconnected">
            Bot Status: Disconnected
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div class="controls">
            <button id="startBot" class="button start">Resume Bot</button>
            <button id="stopBot" class="button stop">Stop Bot</button>
            <button id="resetBot" class="button reset">Reset Bot</button>
            <button id="downloadContacts" class="button download">Download Contacts</button>
        </div>

        <div id="qrCode" class="qr-code" style="display: none;">
            <h2>Scan QR Code</h2>
            <img id="qrCodeImage" src="" alt="QR Code">
        </div>

        <div class="controls-description fade-in">
            <div class="description-title">
                üéÆ Control Panel Guide
            </div>
            <div class="button-descriptions">
                <div class="button-description">
                    <div class="button-icon start">‚ñ∂Ô∏è</div>
                    <div class="button-info">
                        <div class="button-name">Resume Bot</div>
                        <div class="button-detail">
                            Starts or resumes the bot using existing session data. Use this to continue bot operations after a pause.
                        </div>
                    </div>
                </div>
                <div class="button-description">
                    <div class="button-icon stop">‚è∏Ô∏è</div>
                    <div class="button-info">
                        <div class="button-name">Stop Bot</div>
                        <div class="button-detail">
                            Temporarily stops the bot while keeping all session data intact. Use this for temporary maintenance.
                        </div>
                    </div>
                </div>
                <div class="button-description">
                    <div class="button-icon reset">üîÑ</div>
                    <div class="button-info">
                        <div class="button-name">Reset Bot</div>
                        <div class="button-detail">
                            Completely resets the bot by clearing all session data. Use this if you're experiencing issues or need to re-authenticate. Requires scanning QR code again.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="commands-section fade-in">
            <div class="commands-title">
                üìù WhatsApp Commands Reference
            </div>
            <div class="commands-grid">
                <div class="command-group admin">
                    <div class="command-group-title">
                        üëë Admin Commands
                    </div>
                    <div class="command-list">
                        {% for command in commands.admin.commands %}
                        <div class="command-item">
                            <span class="command-name">{{ command.name }}</span>
                            <span class="command-description">{{ command.description }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="command-group moderator">
                    <div class="command-group-title">
                        üõ°Ô∏è Moderator Commands
                    </div>
                    <div class="command-list">
                        {% for command in commands.moderator.commands %}
                        <div class="command-item">
                            <span class="command-name">{{ command.name }}</span>
                            <span class="command-description">{{ command.description }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="command-group user">
                    <div class="command-group-title">
                        üë§ User Commands
                    </div>
                    <div class="command-list">
                        {% for command in commands.user.commands %}
                        <div class="command-item">
                            <span class="command-name">{{ command.name }}</span>
                            <span class="command-description">{{ command.description }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let qrCheckInterval = null;
        let statusCheckInterval = null;

        // Function to update bot status
        function updateBotStatus() {
            fetch('/bot_status')
                .then(response => response.json())
                .then(data => {
                    isConnected = data.connected;
                    const statusDiv = document.getElementById('status');
                    const statusMessageDiv = document.getElementById('statusMessage');

                    if (data.connected) {
                        statusDiv.textContent = 'Bot Status: Connected';
                        statusDiv.className = 'status connected';
                        document.getElementById('qrCode').style.display = 'none';
                        statusMessageDiv.style.display = 'none';
                        if (qrCheckInterval) {
                            clearInterval(qrCheckInterval);
                            qrCheckInterval = null;
                        }
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                    } else {
                        statusDiv.textContent = 'Bot Status: Disconnected';
                        statusDiv.className = 'status disconnected';
                        
                        // Show delink message if there's an error
                        if (data.error) {
                            statusMessageDiv.style.display = 'block';
                            statusMessageDiv.className = 'status-message error';
                            if (data.error.includes('LOGOUT') || data.error.includes('session')) {
                                statusMessageDiv.innerHTML = '‚ö†Ô∏è Your WhatsApp has been delinked. Please click the <strong>Reset Bot</strong> button and scan the QR code again to reconnect.';
                            } else {
                                statusMessageDiv.innerHTML = '‚ö†Ô∏è ' + data.error;
                            }
                        } else {
                            statusMessageDiv.style.display = 'none';
                        }

                        // Start checking for QR code
                        if (!qrCheckInterval) {
                            checkQRCode();
                            qrCheckInterval = setInterval(checkQRCode, 5000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking bot status:', error);
                    const statusDiv = document.getElementById('status');
                    statusDiv.textContent = 'Bot Status: Error checking status';
                    statusDiv.className = 'status disconnected';
                });
        }

        // Function to check QR code
        function checkQRCode() {
            fetch('/qr_code_exists')
                .then(response => response.json())
                .then(data => {
                    if (data.exists && !isConnected) {
                        document.getElementById('qrCode').style.display = 'block';
                        document.getElementById('qrCodeImage').src = '/get_qr_code?' + new Date().getTime();
                    } else {
                        document.getElementById('qrCode').style.display = 'none';
                    }
                });
        }

        // Clear all intervals
        function clearAllIntervals() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        // Start Bot button click handler (Resume with saved session)
        document.getElementById('startBot').addEventListener('click', () => {
            fetch('/start_bot')
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    clearAllIntervals();
                    // Only check status when starting
                    statusCheckInterval = setInterval(updateBotStatus, 1000);
                });
        });

        // Stop Bot button click handler
        document.getElementById('stopBot').addEventListener('click', () => {
            fetch('/stop_bot')
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    clearAllIntervals();
                    updateBotStatus(); // One final status check
                });
        });

        // Reset Bot button click handler (New session with QR code)
        document.getElementById('resetBot').addEventListener('click', () => {
            fetch('/reset_bot')
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    isConnected = false;
                    clearAllIntervals();
                    // Start both QR and status checks for reset
                    qrCheckInterval = setInterval(checkQRCode, 1000);
                    statusCheckInterval = setInterval(updateBotStatus, 1000);
                });
        });

        // Download Contacts button click handler
        document.getElementById('downloadContacts').addEventListener('click', () => {
            window.location.href = '/download_contacts';
        });

        // Initial one-time status check
        updateBotStatus();
    </script>
</body>
</html>
